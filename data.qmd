---
title: Example datasets
---

Here we download and wrangle the example datasets used in our analyses.

```{r}
#| label: setup

library(tidyverse)
```

Throughout, we use an example dataset from "A primer on two-level dynamic structural equation models for intensive longitudinal data in Mplus" [@mcneishPrimerTwolevelDynamic2020]. Those data are available on the OSF (<https://osf.io/wuprx/>). Here we download, clean, and save the data for use in our analyses.

```{r}
#| label: mh-download

path <- "data/mh.zip"
url <- "https://files.osf.io/v1/resources/wuprx/providers/osfstorage/5bfc839601593f0016774697/?zip="
if (!file.exists(path)) {
  dir.create(dirname(path), showWarnings = FALSE)
  download.file(
    url,
    destfile = path
  )
  unzip(path, exdir = "data/mh/")
}
```

That extracted all the data and Mplus files to `data/` in the project root. We then wrangle the main data file and save for our analyses:

```{r}
#| label: mh-wrangle

d <- read_csv(
  "data/mh/Data/Two-Level Data.csv", 
  col_names = c("urge", "dep", "js", "hs", "person", "time")
) %>% 
  select(
    person, time, js, hs, urge, dep
  ) |> 
  mutate(
    person = factor(person),
    time = as.integer(time-1)
  )
write_rds(d, "data/mcneish-hamaker.rds")
```

```{r data-process}
# The data is cited in the paper as "The dataset generated and analysed during the current study is available in Figshare." (https://uvaauas.figshare.com/articles/dataset/Dataset_belonging_to_Beyens_et_al_2020_The_effect_of_social_media_on_well-being_differs_from_adolescent_to_adolescent/12497990)

# Download data if not yet downloaded
path <- "data/beyens-et-al-2020.sav"
if (!file.exists(path)) {
  dir.create("data", FALSE)
  # Data from figshare
  download.file(
    "https://uvaauas.figshare.com/ndownloader/files/24028271", 
    path
  )
  # Code from OSF
  download.file(
    "https://files.de-1.osf.io/v1/resources/bvfuw/providers/osfstorage/5df9effa64e19d000d0f51da/?zip=",
    "data/Analyses.zip"
  )
  unzip(
    "data/Analyses.zip",
    exdir = "data/Analyses"
  )
}

# Active, Passive, and Total were sums of the platform (e.g. whatsapp) times
d <- read_spss(path) %>% 
  mutate(
    class = factor(ClassNr),
    person = factor(EthicaID),
    # I think they divided this by ten
    time = (OccNrR - 1),
    # active = rowSums(select(., contains("Act")), na.rm = TRUE),
    sm = rowSums(select(., contains("Pas")), na.rm = TRUE) / 60,
    wb = as.numeric(AffWB) / 7, 
    .keep = "none"
  ) %>% 
  arrange(person, class, time)

# Remove times in excess of 60min (1 hour)
d <- d %>% 
  mutate(
    across(c(sm), ~if_else(. > 1, 1, .))
  )

# Centered and lagged variables
d <- d %>% 
  mutate(
    sm_b = mean(sm, na.rm = TRUE),
    sm_c = sm - mean(sm, na.rm = TRUE),
    across(
      c(wb),
      .fns = list(lag = ~lag(.))
    ),
    .by = person
  )

d

write_rds(d, "data/beyens-etal.rds")
```
