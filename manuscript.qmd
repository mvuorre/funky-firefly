---
title: Latent variable and dynamic structural equation models with R and brms
author:
  - name: Matti Vuorre
    url: https://vuorre.com
    orcid: 0000-0001-5052-066X
    email: mjvuorre@uvt.nl
    affiliation:
      - ref: 1
  - name: Ethan McCormick
    affiliation:
      - ref: 3
  - name: Mauricio Garnier-Villarreal
    affiliation:
      - ref: 4
  - name: Joran Jongerling
    orcid: 0000-0001-5697-1381
    affiliation:
      - ref: 1
affiliations:
  - id: 1
    name: Tilburg University
  - id: 3
    name: todo
  - id: 4
    name: todo
authornote: |
  Work in progress.
abstract: |
  Researchers studying links between observed variables in longitudinal and other repeated measures data sets have long recognized the importance of person-mean centering in order to isolate within- and between-person associations. However, a critical issue in centering---treating the person means as unknown parameters rather than observed values---has received less attention among applied practitioners. One reason for this has been the general unavailability and perceived complexity of latent person-mean centering in contrast to observed mean centering. Here, we introduce latent person-mean centering and accessible syntax for implementing it in a wide variety of flexible bayesian models with the R package brms. We demonstrate the syntax, and benefits of latent centering, through an example analysis of social media effects on adolescent well-being. In appendices, we further contrast the performance of latent mean centering to observed mean centering via simulations, and show how it extends to more than two levels of analysis. Latent mean centering provides unbiased estimates of within- and between-person associations, and we hope that the availability and flexibility of our proposed approach motivates researchers to apply this method widely in longitudinal and other multilevel modelling scenarios.
keywords: "longitudinal data, repeated measures, centering, latent variables, R"
bibliography: references.bib
csl: apa.csl
format: 
  docx: default
  html: default
---

```{r setup, include = FALSE}
library(scales)
library(gt)
library(knitr)
library(posterior)
library(ggdist)
library(brms)
library(tidyverse)

# HMC and parallel computation options
MAX_CORES <- as.numeric(Sys.getenv("MAX_CORES"), 4)
options(
  brms.backend = Sys.getenv("BRMS_BACKEND", "rstan"), 
  brms.threads = MAX_CORES %/% 4,
  mc.cores = MAX_CORES
)

# Save models in a directory
dir.create("models", FALSE)

# Plotting options
theme_set(
  theme_linedraw(base_size = 10) +
    theme(
      strip.background = element_rect(fill = "gray90", color = "gray90"),
      strip.text = element_text(color = "black", hjust = 0),
      panel.grid = element_blank()
    )
)

# Document options
knitr::opts_chunk$set(
  echo = FALSE
)
```

# Introduction

Longitudinal and other repeated measures data allow examining associations at two (or more) levels: Between and within individuals [@bolgerIntensiveLongitudinalMethods2013]. Because these separate levels of analysis can indicate different theoretical constructs, researchers have widely recognized the importance of centering the data appropriately, such that within-person associations can be estimated independently from between-person associations [@endersCenteringPredictorVariables2007]. If this distinction between sources of variance is not made, the resulting estimates are likely to be confusing mixtures of associations that occur between individuals and within individuals [@cronbachResearchClassroomsSchools1976 p.18; @raudenbushHierarchicalLinearModels2002 p.138]. Specifically, when a predictor can vary at two levels---observations varying around a person's average, and persons' averages varying around the global average---it is common to manipulate the data such that the analysis distinguishes those two levels.

In typical applications, a predictor is separated into two components: First, each individual's mean is calculated. Second, the individuals' means are subtracted from each observation, leading to a variable that indicates deviations around each person's average. This latter variable represents pure within-person variability. Including it as a predictor leads to estimating how the outcome differs at different levels of the predictor, for the average person. Typically, it is this latter within-person association that is of key theoretical interest in psychology: It can be used to describe a counterfactual causal scenario where increasing the predictor for an individual leads to changes in that person's outcome [@rohrer2023]. Including the person mean as predictor in a regression model will describe the extent to which individuals with different average levels of the predictor differ on the outcome variable.

While simple to implement, this data manipulation trick has one shortcoming: It can lead to biases in the estimated regression coefficients, especially when the number of observations per person is small. These biases result from ignoring the uncertainty inherent in the person means: They can only be estimated based on a sample of limited data, but simple calculations cannot carry this uncertainty forward into the resulting estimates. While this issue is recognized in the methodological literature [e.g. @asparouhovLatentVariableCentering2019; @mcneishPrimerTwolevelDynamic2020], the practical solution to overcome it---latent mean centering---has so far been limited to commercial solutions, most prominently the structural equation modelling software Mplus.

Our aim in this manuscript is to illustrate how latent mean centering can be implemented in the free and open source R language using the brms package [@rcoreteamLanguageEnvironmentStatistical2023; @bÃ¼rkner2017]. 

# A two-level model with latent mean centering

In this example analysis, we examine a longitudinal dataset of Dutch adolescents' social media use and well-being, using the authors' openly available data. In the 7-day experience sampling study, 63 adolescents (54% girls) were surveyed six times per day, on their mobile phones, about their well-being and social media use. During each approximately 2-minute report, participants reported, for variour social media apps, how many minutes in the past hour they used each. They answered this question separately for active and passive use. They also reported their well-being on a seven-point scale ("How happy do you feel right now?"; 1: "Not at all", 4: "A little", 7: "Completely").

With these data, the authors found little relation between active or passive social media use and well-being, but that the associations varied strongly between adolescents. These data are currently among some of the most valuable for addressing associations between adolescents technology use and well-being, and here we use them to illustrate a latent means model in R examining that issue.

```{r}
#| label: tbl-data-1
#| tbl-cap: Example data.

dat <- read_rds("data/beyens-etal.rds")

dat |> 
  slice(1:3, .by = person) |> 
  head() |> 
  kable(digits = 2)
```

Table @tbl-data-1 shows the three first observations of the first two participants in the sample. The first three columns contain a classroom identifier, an anomyous person identifier, and the observation time point (an increasing integer). `sm` is the number of hours of passive social media use in the past hour, and `wb` (for well-being) the happiness rating. (We rescaled these two variables from the original minutes and 1-7 scale to the unit scale.) `wb_lag` is the time-1 lagged version of `wb`.

Our research question with these data is: To what extent does an individual's passive social media use in the past hour predict that individual's current well-being when their immediately preceding well-being is adjusted for? That is, we are specifically interested in the within-person correspondence between social media use and well-being.

## Centering

The issue of isolating between- and within-cluster associations in repeated measures data examined with multilevel models is widely appreciated. The common way to address this issue is to center variables appropriately, such that two new variables are created: One reflecting only between-person variance, and one within-person variance. The variable `sm_c` in @tbl-data-1 is the within-person centered version of social media use; or `sm` from which each person's mean, `sm_b` is subtracted. 

In typical multilevel analyses, including `sm_c` as a level-1 predictor, and `sm_b` as a level-2 predictor leads to two population level parameters that index the extent to which social media use predicts well-being within- and between-people, respectively.

However, using these calculated variables can come with the cost of biased parameter estimates, because this method relies on using `sm_b` as known data when, in reality, it is an unknown quantity estimate from data with its own estimation uncertainty.

Latent mean centering is a method by which the predictor variables are centered within the model such that the estimation uncertainty is incorporated in the calculations.

## Model

We loosely follow the authors' original analysis, which focused on the associations between social media use and well-being. In this analysis, we are interested in the within- and between-person associations between passive social media use in the past hour and current well-being, while adjusting for well-being at the previous timepoint. Because the data consist of repeated measures of multiple individuals, we specify a multilevel model where the regression coefficients are allowed to vary randomly between persons. These models for intensive longitudinal data (ILD) where autocorrelative terms are modelled as random are also sometimes called dynamic structural equation models.

More formally, for each individual i in 1 to 63, and timepoint t in 1 to 42, we model the happiness rating as normally distributed with a common residual standard deviation. We model the mean on an intercept, a regression coefficient of the previous happiness rating, and a coefficient of the current passive social media use variable. We have superscripted the latter two predictor variables with a c, indicating that they are within-person centered. The next two lines define this within-person centering, where the centered value is the raw value minus the estimated person-mean of that variable.

$$
\begin{align}
H_{it} &\sim N(\alpha_i + \phi_i H^c_{it-1} + \beta_i SM^c_{it}, \sigma^2_1), \\
H^{c}_{it} &= H_{it} - \alpha_{1i}, \\
SM_{it} &\sim N(\alpha_{2i}, \sigma^2_2), \\
SM^{c}_{it} &= SM_{it} - \alpha_{2i}.
\end{align}
$$ {#eq-1.1}

Above, we have subscripted all person-specific parameters with i; the means of H and SM (\alpha_1 and \alpha_2, respectively), the autocorrelation in H (\phi_i), and the coefficient of within-person centered SM on H (\beta_i). To complete this model, we specify that all person-specific parameters are multivariate normal distributed.

$$
\begin{align}
\begin{bmatrix}
  \alpha_{1i} \\ \alpha_{2i} \\ \phi_i \\ \beta_i
\end{bmatrix} &\sim MVN\left(
  \begin{bmatrix}
    \bar{\alpha_1} \\ \bar{\alpha_2} \\ \bar{\phi} \\ \bar{\beta}
  \end{bmatrix},
  \begin{pmatrix}
    \tau_{\alpha_1} \  \\ 
    \rho_{\alpha_1\alpha_2} \ &\tau_{\alpha_2} \\ 
    \rho_{\alpha_1\beta} \ &\rho_{\alpha_2\beta} \ &\tau_\beta \\
    \rho_{\alpha_1\phi} \ &\rho_{\alpha_2\phi} \ &\rho_{\beta\phi} \ &\tau_\phi
  \end{pmatrix}
\right)
\end{align}
$$ {#eq-1.2}

This model is difficult to specify in common multilevel modelling software, because it shares parameters across regression models of different outcomes. Specifically, in @eq-1.1 we create the within-person centered variable $SM^c_{it}$ "dynamically" within the model by subtracting the estimated mean of SM for person i from the current observation. In other words, @eq-1.1 is a multivariate model where some parameters are shared across the outcomes. However, there is a somewhat simple solution to this issue: We can "stack" the multivariate data two a longer univariate data table. @tbl-data-2 shows the result of this data stacking: Instead of separate columns for SM and H, there are now two indicator columns `i_wb` and `i_sm` that are 1 when that outcome is in the `value` column and 0 otherwise. 

```{r}
#| label: tbl-data-2
#| tbl-cap: Example data 2.

dat <- dat |> 
  pivot_longer(sm:wb, names_to = "outcome") |> 
  mutate(
    i_wb = if_else(outcome == "wb", 1, 0),
    i_sm = if_else(outcome == "sm", 1, 0), 
    .before = value
  ) |> 
  left_join(dat)

dat |> 
  slice(1:3, .by = person) |> 
  head() |> 
  kable(digits = 2)
```

In practice, we can then use this stacked data and reparameterize our model as a univariate model:

$$
\begin{align}
Y_{it} &\sim N(\eta_{it}, \sigma_{it}^2), \\
\eta_{it} &= 
  I_{WBit}(\alpha_{1i} + 
    \phi_i(H_{it-1} - \alpha_{1i}) + 
    \beta_i(SM_{it} - \alpha_{2i})) + 
  I_{SMit}(\alpha_{2i}), \\
\sigma_{it} &= \text{exp}(I_{WBit}\omega_1 + I_{SMit}\omega_2).
\end{align}
$$

This model then estimates the latent mean of H (\alpha_1) and SM (\alpha_2), the autoregressive coefficient of H (\phi) and coefficient of SM on H (\beta). Importantly, the last line also models separate residual standard deviations for the two outcomes by specifying a linear model of the two outcome indicator variables, and then passing the linear predictor through a log-link function.

Using the data in @tbl-data-2, we can now specify this model using brms' model syntax:

```{r}
model <- bf(
  value ~ 
    i_wb * (alpha1 + phi * (wb_lag - alpha1) + beta * (sm - alpha2)) + 
    i_sm * alpha2,
  nlf(sigma ~ i_wb * omega1 + i_sm * omega2),
  alpha1 + alpha2 + phi + beta ~ 1 + (1 |p| person),
  sigma1 + sigma2 ~ 1,
  nl = TRUE
)
```

```{r}
fit <- brm(
  bform,
  data = d,
  iter = ITER,
  control = list(adapt_delta = 0.95),
  file = "cache/brm-example-sm-1"
)
```

With these data, model estimation took about one minute on a modern laptop computer. We show the estimated population-level parameters in @tbl-model-1.

```{r}
#| label: tbl-model-1
#| tbl-cap: Model results.

as_draws_df(fit, variable = c("b_", "sd_", "cor_"), regex = TRUE) %>% 
  rename_with(~str_remove_all(., "_Intercept")) |> 
  mutate(
    across(starts_with("b_sigma"), ~exp(.))
  ) |> 
  summarise_draws(
    mean, sd, ~quantile2(.x, c(.025, .975))
  ) |> 
  kable(digits = 2)
```


# A three-level model with latent mean centering

# Discussion

## Advantages

Using brms for latent means models enables the use of a wide variety of methods, including nonlinear model terms, smooth terms (generalized additive mixed models), mixture models, and more.

## Limitations

Here, we outlined the use of the general-purpose regression modelling R package brms for estimating latent means models. This approach has two main limitations. First, by requiring us to stack the data we cannot model different variables using different distributions. In our examples, we assumed that all outcomes were normally distributed. This practical limitation can be problematic in cases, for example, when one of the outcomes is binary and the other one is a continuous variable. Second, although a wide variety of e.g. cross-lagged location-scale within-between latent means models can be fitted with brms, the commercial alternative Mplus is currently more flexible. For example, users of Mplus can specify residual DSEMs which cannot be fitted with brms.

Moreover, data stacking increases the practical size of the dataset and thus can be slower to estimate than a true multivariate model, such as ones that can be fitted with Mplus.

Missing data.

# Author Contributions

Conceptualization: MV\
Methodology: MV\
Software: MV\
Validation: MV\
Formal Analysis: MV\
Data Curation: MV\
Writing---Original Draft: MV\
Writing---Review & Editing: MV\
Visualization: MV\
Project Administration: MV

# Conflicts of Interest

The author(s) declare that there were no conflicts of interest with respect to the authorship or the publication of this article.
