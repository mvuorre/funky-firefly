---
title: 'Bias no more! A practical guide to latent mean centering in multilevel models'
shorttitle: Latent mean centering
leftheader: Latent mean centering
author: 
  - name: Matti Vuorre
    affiliation: 1
    corresponding: yes
    address: Oxford Internet Institute, University of Oxford
    email: matti.vuorre@oii.ox.ac.uk
    role:
      - role mcrole
  - name: Author McAuthor
    affiliation: 2
    address: Address McAddress
    email: email@mcemail.com
    role:
      - role mcrole

affiliation:
  - id: 1
    institution: Oxford Internet Institute, University of Oxford
  - id: 2
    institution: Institution McInstitution

authornote: |
  \noindent \textbf{This manuscript is not yet peer-reviewed.}
  
abstract: |
  Here's a plan.
  
  - Longitudinal and repeated measures are becoming more common because SCIENCE
  - Centering is crucial, but...
  - Latent mean centering! Like a whole section of words!
  - tbd
  
keywords: words, key
wordcount: "`r wordcountaddin:::word_count(filename = 'ms.Rmd')`"
bibliography: "references.bib"
floatsintext: yes
linenumbers: yes
draft: no
mask: no
figurelist: no
tablelist: no
footnotelist: no
csl: "`r system.file('rmd', 'apa7.csl', package = 'papaja')`"
documentclass: apa7
classoption: jou
output: 
  papaja::apa6_pdf:
    number_sections: false
    keep_tex: false
  papaja::apa6_docx: 
    number_sections: false
---

```{r setup, include = FALSE}
library(papaja)
library(posterior)
library(scales)
library(ggdist)
library(brms)
library(tidyverse)

# HMC and parallel computation options
MAX_CORES <- as.numeric(Sys.getenv("MAX_CORES"))
if (is.na(MAX_CORES)) MAX_CORES <- parallel::detectCores(logical = FALSE)
THREADS <- 1
CORES <- MAX_CORES
ITER <- 10000
if (require(cmdstanr)) {
  options(brms.backend = "cmdstanr")
  THREADS <- MAX_CORES %/% 4
}

# Save models in a directory
dir.create("models", FALSE)

# Plotting options
theme_set(
  theme_linedraw(base_size = 9.6) +
    theme(
      strip.background = element_rect(fill = "gray90", color = "gray90"),
      strip.text = element_text(color = "black", hjust = 0),
      panel.grid = element_blank()
    )
)
```

# Introduction

## Centering

## Latent mean centering

# Example analysis

<!-- Just a toy example for now to write some code -->

```{r}
# Data from McNeish
d <- read_csv("data/Two-Level Data.csv", col_names = FALSE)[,c(5:6,1:2)]
names(d) <- c("person","time","urge", "dep")
d <- d %>% 
  # Create lagged variable
  group_by(person) %>% 
  mutate(urge1 = lag(urge)) %>% 
  ungroup()

# Model definition from https://discourse.mc-stan.org/t/latent-mean-centering-latent-covariate-models-in-brms/29424/22
# Estimate depBI (latent means) using nlf() inside bf()
model <- bf(
  urge ~ alpha + phi*(urge1 - alpha) + beta*(dep - depB),
  alpha ~ 1 + (1 | person),
  phi ~ 1 + (1 | person),
  beta ~ 1 + (1 | person),
  nlf(depB ~ depBI),
  depBI ~ 1 + (1 | person),
  nl = TRUE
) +
  gaussian()

p <- get_prior(model, data = d) %>%
  mutate(
    prior = case_when(
      class == "b" & coef == "Intercept" ~ "normal(0, 1.5)",
      class == "sd" & coef == "Intercept" ~ "student_t(7, 0, 1)",
      TRUE ~ prior
    )
  )

fit1 <- brm(
  model,
  data = d,
  prior = p,
  cores = MAX_CORES,
  threads = THREADS,
  iter = ITER,
  control = list(adapt_delta = 0.99),
  file = "models/m_mh91"
)

# Code example from Ethan McCormick
# Matti's code edited to add `depb` as 'main effect'
# Estimate model without nlf() with depb added to the first formula
# This seems to be slightly different as it adds depb as predictor of urge?
# But under typical conditions these should give similar key estimates (?)
model <- bf(
  urge ~ alpha + phi*(urge1 - alpha) + depb + beta*(dep - depb),
  alpha ~ 1 + (1 | person),  # Latent intercept of urge
  depb ~ 1 + (1 | person),  # Latent mean of depression
  phi ~ 1 + (1 | person),  # Slope of latent mean-person centered lagged urge on urge
  beta ~ 1 + (1 | person),  # Slope of latent mean-person centered depression on urge
  nl = TRUE,
  center = FALSE. # This seems key
) +
  gaussian()

#Set priors
p <- get_prior(model, data = d) %>% 
  mutate(
    prior = case_when(
      class == "b" & coef == "Intercept" ~ "normal(0, 1.5)",
      class == "sd" & coef == "Intercept" ~ "student_t(7, 0, 1)",
      TRUE ~ prior
    )
  )

fit2 <- brm(
  model,
  data = d,
  prior = p, 
  cores = MAX_CORES,
  threads = THREADS,
  iter = ITER,
  control = list(adapt_delta = 0.99),
  file = "models/m_mh5"
)

bind_rows(
  as_draws_df(fit1, variable = c("b_", "sd_", "sigma"), regex = TRUE),
  as_draws_df(fit2, variable = c("b_", "sd_", "sigma"), regex = TRUE) %>% 
    rename_with(~str_replace(., "depb", "depBI")), 
  .id = "Model"
) %>% 
  mutate(
    Model = factor(Model, labels = c("nlf()", "bf()")),
    ) %>% 
  select(-c(.chain, .iteration, .draw)) %>% 
  pivot_longer(-Model) %>% 
  ggplot(aes(value, name, col = Model, fill = Model)) +
  stat_halfeye(
    data = . %>% filter(Model == "nlf()"),
    side = "top", normalize = "xy", height = .5
  ) +
  stat_halfeye(
    data = . %>% filter(Model == "bf()"),
    side = "bottom", normalize = "xy", height = .5
  )
```


# Simulation study

# Discussion

R [@rcoreteamLanguageEnvironmentStatistical2022]

\clearpage

# Acknowledgements

We would like to thank Mauricio Garnier-Villarreal, Simon Brauer, Ethan McCormick, and everyone else who contributed to the discussion and development of the correct brms syntax on the Stan discussion board (https://discourse.mc-stan.org/t/latent-mean-centering-latent-covariate-models-in-brms/29424). Special thanks to Mauricio Garnier-Villarreal for being the first to post the syntax that the code here was based on. We believe developing methods and theories collaboratively, and in the open, to be a fruitful path forward in better understanding human behavior and how to best model it.

# References

::: {#refs custom-style="Bibliography"}
:::


<!-- Create an appendix with new page, table, and figure numbers. -->

\clearpage
\onecolumn

# Appendix A: Appendix McAppendix

<!-- Prepend table & figure numbers with S and reset counters -->
\setcounter{page}{1}
\setcounter{table}{0}
\setcounter{figure}{0}
\renewcommand{\thetable}{A\arabic{table}}
\renewcommand{\thefigure}{A\arabic{figure}}

```{r include-only-for-pdf}
#| include: !expr knitr::is_latex_output()
```
